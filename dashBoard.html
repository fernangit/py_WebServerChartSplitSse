<!DOCTYPE html>
<html lang="ja">
 
<head>
  <meta charset="UTF-8">
  <title>IOT Dashboad</title>
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script> 
<script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
  <script src="assets/js/Chart.min.js"></script>
  <script src="assets/js/chartjs-plugin-labels.js"></script>
</head>
 
<body>
  <div class="container">
      <div class="first-row">
        <div class="area area-1">
            <div class="area-body">
              <h1 class="area-title">Office Atmosphere</h1>
              <div class="area-text2">
                <p id="area-text2-1"></p>
              </div>
            </div>
        </div>
 
        <div class="area area-2">
            <div class="area-body">
              <h1 class="area-title">Atmosphere Chart</h1>
              <p class="area-text1"></p>
                <canvas id="canvas"></canvas>
            </div>
        </div>
 
        <div class="area area-3">
            <div class="area-body">
              <h1 class="area-title">Office Air</h1>
              <div class="area-text2">
                <p id="area-text2-2"></p>
              </div>
            </div>
        </div>
        <div class="area area-4">
            <div class="area-body">
              <h1 class="area-title">Office Sensor</h1>
              <div class="area-text1">
                <p id="area-text1-1"></p>
              </div>
            </div>
        </div>
      </div>


      <div class="second-row">
        <div class="card card-1">
            <div class="card-body">
              <h2 id="card-title1"></h2>
              <div class="item">
                <p id="item-text1"></p>
                <p id="item-text2"></p>
                <p id="item-text3"></p>
                <p id="item-text4"></p>
                <p id="item-text5"></p>
                <p id="item-text6"></p>
                <p id="item-text7"></p>
                <p id="item-text8"></p>
                <p id="item-text9"></p>
                <p id="item-text10"></p>
                <p id="item-text11"></p>
              </div>
            </div>
        </div>
 
        <div class="card card-2">
            <div class="card-body">
              <h2 class="card-title2">Today's<br>Weather</h2>
              <div><span id = "weather1" class="bold"></span></div>
              <div><span id = "weatherMark1" class="bold"></span></div>
              <p id="icon"></p>
              <div>気温　<span id = "temp1"  class="bold"></span>　℃</div>
              <div>湿度　<span id = "humidity1" class="bold"></span>　%</div>
            </div>
        </div>
 
        <div class="card card-3">
            <div class="card-body">
              <h2 class="card-title3">Tommorow's Weather</h2>
              <div><span id = "weather2" class="bold"></span></div>
              <div><span id = "weatherMark2" class="bold"></span></div>
              <p id="icon"></p>
              <div>気温　<span id = "temp2"  class="bold"></span>　℃</div>
              <div>湿度　<span id = "humidity2" class="bold"></span>　%</div>
            </div>
        </div>
      </div>

  </div>
  

<script>
emotion = new Array(7);
emotion[0] = 1;
emotion[1] = 2;
emotion[2] = 4;
emotion[3] = 10;
emotion[4] = 21;
emotion[5] = 12;
emotion[6] = 9;
bestIndex = 0;
let eventSrc = new EventSource("/sse")
eventSrc.addEventListener("message", getMessage)
eventSrc.addEventListener("error", (e) => { console.dir(e) })
          
//SSEメッセージ受信
function getMessage(e) {
//    emotion[Math.floor( Math.random() * 7)] = parseInt(e.data, 10);
//    console.log(parseInt(e.data, 10));
    obj = JSON.parse(e.data);
    console.log(obj);
    emotion[0] = obj.angry;
    emotion[1] = obj.disgust;
    emotion[2] = obj.fear;
    emotion[3] = obj.happy;
    emotion[4] = obj.sad;
    emotion[5] = obj.surprise;
    emotion[6] = obj.neutral;
    emotion[Math.floor( Math.random() * 7)] = obj.angry;
    console.log(emotion[Math.floor( Math.random() * 7)]);
    console.log(Math.floor( Math.random() * 7));
    //感情の最大値Index
    bestIndex = emotion.indexOf(Math.max.apply(null, emotion));
    console.log(bestIndex);
    if(window.myLine){
       //グラフ破棄
       window.myLine.destroy();
    }
    //グラフ描画
    drawChart(emotion);
    //顔文字描画
    drawFace(bestIndex);
}

//グラフ描画
function drawChart(emotion) {
    var ctx = document.getElementById("canvas").getContext("2d");
    var option = {
      animation: false,
      legend: {
        display: false
      },
      plugins: {
        labels: {
          render: 'label',
          fontColor: '#ffffff',
 //         position: 'outside',
        }
      }
    };
    window.myLine = new Chart(ctx, {
      type: 'pie',
      options: option,
      data: {
        labels: ["angry", "disgust", "fear", "happy", "sad", "surprise", "neutral"],
        datasets: [{
          backgroundColor: [
            "#2ecc71",
            "#3498db",
            "#95a5a6",
            "#9b59b6",
            "#f1c40f",
            "#e74c3c",
            "#34495e"
          ],
          data: [emotion[0], emotion[1], emotion[2], emotion[3], emotion[4], emotion[5], emotion[6]]
        }],
      }
    });
}

//顔文字描画
function drawFace(index) {
    var titleId = "area-text2-1";
    var p = document.getElementById(titleId);
    console.log(p);
    if(index == 0){ //angry
        p.innerHTML="(`д´*)"
    }else if(index == 1){ //disgust
        p.innerHTML="(´д`)"
    }else if(index == 2){ //fear
        p.innerHTML="('д';)"
    }else if(index == 3){ //happy
        p.innerHTML="(^-^)"
    }else if(index == 4){ //sad
        p.innerHTML="(T_T)"
    }else if(index == 5){ //surprise
        p.innerHTML="(@o@)"
    }else if(index == 6){ //neutral
        p.innerHTML="(o_o)"
    }else{
        p.innerHTML="(+_+)"
    }
}
</script>

<script>
function getNews()
{
    var url = 'https://newsapi.org/v2/top-headlines?country=jp&category=business&pageSize=11&apiKey=2bea3b0f1dc646aca06bae5010a7cf4a';

    var req = new Request(url);
    fetch(req).then(function(response) {
        return response.json();
    }).then(function(json) {
        console.log(json)
        for (var i=0;i<json.articles.length;i++) {
                var titleId = "item-text" + (i+1);
                console.log(titleId);
                var p = document.getElementById(titleId);
                p.innerHTML = '・' + json.articles[i].title;
        }
    });
}
</script>

<script>
function getDate()
{
    //今日の日付データを変数dateに格納
    var date=new Date(); 
    //年・月・日・曜日を取得する
    var year = date.getFullYear();
    var month = date.getMonth()+1;
    var week = date.getDay();
    var day = date.getDate();
    var weeks= new Array("日","月","火","水","木","金","土");
    return (year+"年"+month+"月"+day+"日（"+weeks[week]+"）");
}

function weatherIcon(param, spanId)
{
            //天気に応じた天気アイコンを表示させる
            switch (param){
            case 'Clouds':
            $(spanId).html("<img src='http://openweathermap.org/img/w/04d.png'>");
            break;
            case 'Snow':
            $(spanId).html("<img src='http://openweathermap.org/img/w/13d.png'>");
            break;
            case 'Rain':
            $(spanId).html("<img src='http://openweathermap.org/img/w/09d.png'>");
            break;
            case 'Clear':
            $(spanId).html("<img src='http://openweathermap.org/img/w/01d.png'>");
            break;
            case 'Fog':
            $(spanId).html("<img src='http://openweathermap.org/img/w/50d.png'>");
            break;
            case 'Mist':
            $(spanId).html("<img src='http://openweathermap.org/img/w/50n.png'>");
            break;
            case 'Haze':
            $(spanId).html("<img src='http://openweathermap.org/img/w/50d.png'>");
            break;
            default:
            $(spanId).html("<img src='http://openweathermap.org/img/w/01n.png'>");
        }
}

function getWeather(cityId)
{
    //JSONデータ取得 日本語で天気名を表示したいのでlang=ja　として日本語表記データを取得
    $.post("http://api.openweathermap.org/data/2.5/forecast/daily?id=" + cityId + "&appid=cc05750ba50400f27ebabbcd6f4c4976&lang=ja&units=metric&cnt=2",  
        function(json){
            console.log(json);
            console.log(json.city.name);
            $("#titleScript").html(json.city.name + "のお天気は？");
            $("#weather1").html(json.list[0].weather[0].description);
            $("#humidity1").html(json.list[0].humidity);
            $("#temp1").html(Math.round(json.list[0].temp.day));
            weatherIcon(json.list[0].weather[0].main, "#weatherMark1");
            $("#weather2").html(json.list[1].weather[0].description);
            $("#humidity2").html(json.list[1].humidity);
            $("#temp2").html(Math.round(json.list[1].temp.day));
            weatherIcon(json.list[1].weather[0].main, "#weatherMark2");
        }
    );
}
</script>

<script>
function writeSmell(index) {
    var titleId = "area-text2-2";
    var p = document.getElementById(titleId);
    console.log(p);
    if(index == 0){ //bad
        p.innerHTML="Smell Bad!!"
    }else if(index == 1){ //good
        p.innerHTML="Smell Good!!"
    }else{
        p.innerHTML="????"
    }
}
</script>

<script>
function writeSensor(value) {
    var titleId = "area-text1-1";
    var p = document.getElementById(titleId);
    console.log(p);
    p.innerHTML="気温　" + value + "　℃"
}
</script>

<script>
const RELOAD_INTERVAL_TIME=1000*60*60;
function sendRequest()
{
    var h = document.getElementById("card-title1");
    console.log(h)
    h.innerHTML = getDate() + "のNews";
    getNews();
    getWeather(1850147);
    drawFace(6);
    drawChart(emotion);
    writeSmell(0);
    writeSensor(9)
}

sendRequest();
setInterval(sendRequest, RELOAD_INTERVAL_TIME);
</script>  
  
</body>
</html>